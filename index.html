<!DOCTYPE html>
<html lang="fr">
<head>
 <script>
  (function () {
    try {
      var token = localStorage.getItem('authToken');
      if (!token) {
        window.location.replace('login.html');
      }
    } catch (e) {
      window.location.replace('login.html');
    }
  })();
</script>




<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ma Boutique - Gestion Complète</title>
<meta name="api-base" content="https://ma-boutique-backend-3.onrender.com">
<script src="https://cdn.tailwindcss.com"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- PWA meta -->
<link rel="manifest" href="./pwa/manifest.json">
<meta name="theme-color" content="#6D28D9">
<!-- iOS support -->
<link rel="apple-touch-icon" href="/pwa/icons/apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="mobile-web-app-capable" content="yes">


<style>
    .app-container {
        max-width: 100%; width: 100%; max-width: 900px;
        margin: 0 auto;
        box-shadow: 0 0 30px rgba(0,0,0,0.2);
        border-radius: 25px;
        overflow: hidden;
        background: white;
        min-height: 100vh;
    }
    .big-button {
        transition: all 0.25s ease;
        transform: scale(1);
    }
    .big-button:hover { transform: scale(1.03); }
    .slide-in { animation: slideIn 0.35s ease-out; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0;} to { transform: translateX(0); opacity: 1;} }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.7; } }
    .category-habits { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .category-cosmetiques { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .category-chaussures { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
    .category-accessoires { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }

    /* Mobile adjustments */
    @media (max-width: 600px) {
        .big-button { font-size: 1.05rem; padding: 1rem; }
        .app-container { border-radius: 8px; min-height: 100vh; }
        header, .bg-gradient-to-r { border-radius: 0; }
        .text-2xl { font-size: 1.25rem; }
        .text-6xl { font-size: 2.2rem; }
    }

    @media (min-width: 601px) {
        .app-container { border-radius: 15px; }
    }
    /* Simple table responsive */
    .table-sm td, .table-sm th { padding: 0.5rem; }

.chart-container {
    height: 250px;
}
</style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-pink-50">
  <div id="syncBanner" style="display:none;" class="bg-blue-500 text-white text-center py-2 text-sm">
  🔄 Synchronisation en cours...
</div>

<div class="app-container">
  <!-- En-tête -->
  <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-6">
    <div class="flex items-center justify-between">
      <button class="text-3xl" id="backBtn" onclick="showSection('menu')" style="display: none;">←</button>
      <div class="text-center flex-1">
        <h1 class="text-2xl font-bold">🏪 Ma Boutique</h1>
        <div class="text-sm opacity-90">Ventes aujourd'hui: <span class="pulse" id="ventesToday">0</span></div>
      </div>
      <div class="text-3xl pulse">💰</div>
    </div>
  </div>

  <!-- Menu Principal -->
  <div class="p-6 space-y-6" id="menuSection">

    <!-- Résumé du jour -->
    <div class="bg-white rounded-3xl p-6 shadow-lg">
      <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
        <span class="text-2xl mr-2">📊</span> Aujourd'hui
      </h3>
      <div class="grid grid-cols-3 gap-4">
        <div class="text-center bg-green-50 rounded-2xl p-4">
          <div class="text-2xl font-bold text-green-600" id="chiffreAffaires">0 F</div>
          <div class="text-xs text-green-700">Argent reçu</div>
        </div>
        <div class="text-center bg-blue-50 rounded-2xl p-4">
          <div class="text-2xl font-bold text-blue-600" id="articlesVendus">0</div>
          <div class="text-xs text-blue-700">Articles vendus</div>
        </div>
        <div class="text-center bg-orange-50 rounded-2xl p-4">
          <div class="text-2xl font-bold text-orange-600" id="stockTotal">0</div>
          <div class="text-xs text-orange-700">En stock</div>
        </div>
      </div>
    </div>

    <!-- Actions principales (ajouté Inventaire à côté de Rapports) -->
    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
      <button class="big-button bg-gradient-to-br from-green-400 to-green-600 text-white p-8 rounded-3xl text-center shadow-lg" onclick="showSection('vente')">
        <div class="text-6xl mb-3">💳</div>
        <div class="font-bold text-xl">VENDRE</div>
        <div class="text-sm opacity-90">Vendre un article</div>
      </button>

      <button class="big-button bg-gradient-to-br from-blue-400 to-blue-600 text-white p-8 rounded-3xl text-center shadow-lg" onclick="showSection('stock')">
        <div class="text-6xl mb-3">📦</div>
        <div class="font-bold text-xl">STOCK</div>
        <div class="text-sm opacity-90">Gérer produits</div>
      </button>

      <button class="big-button bg-gradient-to-br from-purple-400 to-purple-600 text-white p-8 rounded-3xl text-center shadow-lg" onclick="showSection('categories')">
        <div class="text-6xl mb-3">🏷️</div>
        <div class="font-bold text-xl">CATÉGORIES</div>
        <div class="text-sm opacity-90">Organiser</div>
      </button>

      <button class="big-button bg-gradient-to-br from-orange-400 to-orange-600 text-white p-8 rounded-3xl text-center shadow-lg" onclick="showSection('rapports')">
        <div class="text-6xl mb-3">📈</div>
        <div class="font-bold text-xl">CHIFFRES</div>
        <div class="text-sm opacity-90">Voir gains</div>
      </button>

      <button class="big-button bg-gradient-to-br from-teal-400 to-teal-600 text-white p-8 rounded-3xl text-center shadow-lg" onclick="showSection('inventaire')">
        <div class="text-6xl mb-3">📋</div>
        <div class="font-bold text-xl">INVENTAIRE</div>
        <div class="text-sm opacity-90">Voir bénéfices</div>
      </button>
    </div>

    <!-- Alertes stock faible -->
    <div class="bg-gradient-to-r from-red-100 to-orange-100 rounded-3xl p-6 shadow-lg" id="alertesStock" style="display: none;">
      <h3 class="text-lg font-bold mb-4 flex items-center text-red-700"><span class="text-2xl mr-2">⚠️</span> Presque fini</h3>
      <div class="space-y-2" id="produitsStockFaible"></div>
    </div>
  </div>

  <!-- Section Vente -->
  <div class="hidden slide-in p-6" id="venteSection">
    <h2 class="text-2xl font-bold mb-6 text-center">💳 Vendre</h2>

    <!-- Panier -->
    <div class="bg-white rounded-3xl p-6 shadow-lg mb-6">
      <h3 class="text-lg font-bold mb-4 flex items-center"><span class="text-2xl mr-2">🛒</span> Panier</h3>
      <div class="space-y-3 mb-4 min-h-[100px]" id="panierItems">
        <div class="text-gray-500 text-center py-8"><div class="text-4xl mb-2">🛒</div><div>Panier vide</div></div>
      </div>
      <div class="border-t pt-4">
        <div class="flex justify-between items-center text-2xl font-bold mb-4"><span>TOTAL:</span><span class="text-green-600" id="totalPanier">0 F</span></div>
        <button class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-4 rounded-2xl font-bold text-lg shadow-lg" onclick="showModal('paiement')">💰 ENCAISSER</button>
      </div>
    </div>

    <!-- Sélection par catégorie -->
    <div class="space-y-4">
      <h3 class="text-lg font-bold">Choisir produits</h3>
      <div class="grid grid-cols-2 gap-3" id="categoriesVente"></div>
    </div>
  </div>

  <!-- Section Stock -->
  <div class="hidden slide-in p-6" id="stockSection">
    <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">📦 Mon Stock</h2><button class="bg-blue-600 text-white px-4 py-2 rounded-2xl text-sm font-bold" onclick="showModal('ajoutProduit')">+ AJOUTER</button></div>
    <div class="flex gap-2 mb-6 overflow-x-auto pb-2" id="filtreCategories"><button class="filtre-btn bg-blue-500 text-white px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap" onclick="filtrerProduits('tous')">Tous</button></div>
    <div class="space-y-4" id="listeProduits"></div>
  </div>

  <!-- Section Catégories -->
  <div class="hidden slide-in p-6" id="categoriesSection">
    <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">🏷️ Catégories</h2><button class="bg-purple-600 text-white px-4 py-2 rounded-2xl text-sm font-bold" onclick="showModal('ajoutCategorie')">+ AJOUTER</button></div>
    <input type="text" id="searchCategorie" placeholder="🔍 Rechercher une catégorie..." class="w-full p-2 border rounded mb-4">
    <div class="space-y-4" id="listeCategories"></div>
  </div>

  <!-- Section Rapports (CHIFFRES) -->
  <div class="hidden slide-in p-6" id="rapportsSection">
    <h2 class="text-2xl font-bold mb-6 text-center">📈 Chiffres</h2>
    <div class="space-y-6">
      <div class="bg-white rounded-3xl p-6 shadow-lg">
        <h3 class="text-lg font-bold mb-4">💰 Résumé</h3>
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-green-50 rounded-2xl p-4 text-center"><div class="text-3xl font-bold text-green-600" id="recettesJour">0 F</div><div class="text-sm text-green-700">Aujourd'hui</div></div>
          <div class="bg-blue-50 rounded-2xl p-4 text-center"><div class="text-3xl font-bold text-blue-600" id="recettesSemaine">0 F</div><div class="text-sm text-blue-700">Cette semaine</div></div>
        </div>
      </div>

      <div class="bg-white rounded-3xl p-6 shadow-lg">
        <h3 class="text-lg font-bold mb-4">💳 Paiements</h3>
        <div class="space-y-3" id="rapportsPaiements"></div>
      </div>

      <div class="bg-white rounded-3xl p-6 shadow-lg">
        <h3 class="text-lg font-bold mb-4">🔥 Produits Populaires</h3>
        <div class="space-y-3" id="produitsPopulaires"></div>
      </div>

      <!-- Graphiques -->
      <div class="bg-white rounded-3xl p-6 shadow-lg">
        <h3 class="text-lg font-bold mb-4">📊 Graphiques</h3>
        
<div class="chart-container"><canvas id="chartVentesByDay"></canvas></div>
<div class="chart-container"><canvas id="chartTopProduits"></canvas></div>
<div class="chart-container"><canvas id="chartPaiements"></canvas></div>
<div class="chart-container"><canvas id="chartStocksFaibles"></canvas></div>
<h2 class="text-lg font-bold mt-6 mb-2">Historique des ventes</h2>
<canvas id="chartVentesJour" height="100"></canvas>

</div>

    </div>
  </div>

  <!-- Section Inventaire -->
  <div class="hidden slide-in p-6" id="inventaireSection">
    <h2 class="text-2xl font-bold mb-6 text-center">📋 Inventaire & Bénéfices</h2>
    <input type="text" id="searchInventaire" placeholder="🔍 Rechercher un produit..." class="w-full p-2 border rounded mb-4">
    <div class="bg-white rounded-3xl p-4 shadow-lg">
      <table class="w-full table-sm">
        <thead class="bg-gray-100"><tr><th class="p-2 border">Produit</th><th class="p-2 border">Achat</th><th class="p-2 border">Vente</th><th class="p-2 border">En stock</th><th class="p-2 border">Vendues</th><th class="p-2 border">Bénéfice réalisé</th></tr></thead>
        <tbody id="inventaireListe"></tbody>
      </table>
    </div>
  </div>

  <!-- Modales -->
  <div class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4" id="modalOverlay">

    <!-- Modal Ajout Produit -->
    <div class="bg-white rounded-3xl p-6 w-full max-w-sm hidden fade-in" id="modalAjoutProduit">
      <h3 class="text-2xl font-bold mb-6 text-center">📦 Nouveau Produit</h3>
      <div class="space-y-4">
        <input class="w-full p-4 border-2 rounded-2xl text-lg" id="nomProduit" placeholder="Nom du produit" type="text"/>
        <select class="w-full p-4 border-2 rounded-2xl text-lg" id="categorieProduit"><option value="">Choisir catégorie</option></select>
        <input class="w-full p-4 border-2 rounded-2xl text-lg" id="prixAchatProduit" placeholder="Prix achat (F CFA)" type="number"/>
        <input class="w-full p-4 border-2 rounded-2xl text-lg" id="prixProduit" placeholder="Prix vente (F CFA)" type="number"/>
        <input class="w-full p-4 border-2 rounded-2xl text-lg" id="stockProduit" placeholder="Quantité en stock" type="number"/>
        <textarea class="w-full p-4 border-2 rounded-2xl text-lg h-20" id="descriptionProduit" placeholder="Description (optionnel)"></textarea>
        <div class="flex gap-3">
          <button class="flex-1 bg-gray-300 text-gray-700 py-4 rounded-2xl font-bold" onclick="hideModal()">Annuler</button>
          <button class="flex-1 bg-blue-600 text-white py-4 rounded-2xl font-bold" onclick="ajouterProduit()">Ajouter</button>
        </div>
      </div>
    </div>
    
    <!-- Modal Éditer Produit -->
<div class="bg-white rounded-3xl p-6 w-full max-w-sm hidden fade-in" id="modalEditProduit">
  <h3 class="text-2xl font-bold mb-6 text-center">✏️ Modifier Produit</h3>
  <div class="space-y-4">
    <input class="w-full p-4 border-2 rounded-2xl text-lg" id="editNomProduit" placeholder="Nom du produit" type="text"/>
    <select class="w-full p-4 border-2 rounded-2xl text-lg" id="editCategorieProduit"><option value="">Choisir catégorie</option></select>
    <input class="w-full p-4 border-2 rounded-2xl text-lg" id="editPrixAchatProduit" placeholder="Prix achat (F CFA)" type="number"/>
    <input class="w-full p-4 border-2 rounded-2xl text-lg" id="editPrixProduit" placeholder="Prix vente (F CFA)" type="number"/>
    <input class="w-full p-4 border-2 rounded-2xl text-lg" id="editStockProduit" placeholder="Quantité en stock" type="number"/>
    <textarea class="w-full p-4 border-2 rounded-2xl text-lg h-20" id="editDescriptionProduit" placeholder="Description (optionnel)"></textarea>
    <div class="flex gap-3">
      <button class="flex-1 bg-gray-300 text-gray-700 py-4 rounded-2xl font-bold" onclick="hideModal()">Annuler</button>
      <button class="flex-1 bg-green-600 text-white py-4 rounded-2xl font-bold" onclick="mettreAJourProduit()">Mettre à jour</button>
    </div>
  </div>
</div>

    <!-- Modal Ajout Catégorie -->
    <div class="bg-white rounded-3xl p-6 w-full max-w-sm hidden fade-in" id="modalAjoutCategorie">
      <h3 class="text-2xl font-bold mb-6 text-center">🏷️ Nouvelle Catégorie</h3>
      <div class="space-y-4">
        <input class="w-full p-4 border-2 rounded-2xl text-lg" id="nomCategorie" placeholder="Nom de la catégorie" type="text"/>
        <div class="grid grid-cols-4 gap-3">
          <button class="emoji-btn p-3 text-3xl border-2 rounded-2xl hover:bg-blue-100" onclick="selectEmoji('👕')" type="button">👕</button>
          <button class="emoji-btn p-3 text-3xl border-2 rounded-2xl hover:bg-blue-100" onclick="selectEmoji('💄')" type="button">💄</button>
          <button class="emoji-btn p-3 text-3xl border-2 rounded-2xl hover:bg-blue-100" onclick="selectEmoji('👠')" type="button">👠</button>
          <button class="emoji-btn p-3 text-3xl border-2 rounded-2xl hover:bg-blue-100" onclick="selectEmoji('💍')" type="button">💍</button>
          <button class="emoji-btn p-3 text-3xl border-2 rounded-2xl hover:bg-blue-100" onclick="selectEmoji('🎒')" type="button">🎒</button>
          <button class="emoji-btn p-3 text-3xl border-2 rounded-2xl hover:bg-blue-100" onclick="selectEmoji('👜')" type="button">👜</button>
          <button class="emoji-btn p-3 text-3xl border-2 rounded-2xl hover:bg-blue-100" onclick="selectEmoji('🧴')" type="button">🧴</button>
          <button class="emoji-btn p-3 text-3xl border-2 rounded-2xl hover:bg-blue-100" onclick="selectEmoji('✨')" type="button">✨</button>
        </div>
        <input id="emojiCategorie" type="hidden" value="🏷️"/>
        <div class="flex gap-3">
          <button class="flex-1 bg-gray-300 text-gray-700 py-4 rounded-2xl font-bold" onclick="hideModal()">Annuler</button>
          <button class="flex-1 bg-purple-600 text-white py-4 rounded-2xl font-bold" onclick="ajouterCategorie()">Ajouter</button>
        </div>
      </div>
    </div>

    <!-- Modal Méthodes de Paiement -->
    <div class="bg-white rounded-3xl p-6 w-full max-w-sm hidden fade-in" id="modalPaiement">
      <h3 class="text-2xl font-bold mb-6 text-center">💳 Choisir Paiement</h3>
      <div class="space-y-4">
        <button class="w-full bg-green-500 text-white p-4 rounded-2xl text-lg font-bold flex items-center justify-center gap-3" onclick="finaliserVente('especes')"><span class="text-2xl">💵</span> Espèces</button>
        <button class="w-full bg-blue-500 text-white p-4 rounded-2xl text-lg font-bold flex items-center justify-center gap-3" onclick="finaliserVente('wave')"><span class="text-2xl">📱</span> Wave</button>
        <button class="w-full bg-orange-500 text-white p-4 rounded-2xl text-lg font-bold flex items-center justify-center gap-3" onclick="finaliserVente('orange')"><span class="text-2xl">📞</span> Orange Money</button>
        <button class="w-full bg-gray-300 text-gray-700 p-4 rounded-2xl text-lg font-bold" onclick="hideModal()">Annuler</button>
      </div>
    </div>
  </div>

</div>

<script>

// ---------- CONFIG & DATA ----------
// API_BASE can be set to full URL when deployed. To auto-detect hosted API, set a meta tag in the hosting HTML head like:
// <meta name="api-base" content="https://mon-backend.example.com">
const metaApi = document.querySelector('meta[name="api-base"]');
const API_BASE = metaApi ? metaApi.content : ((location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? '' : ''); // '' -> relative

const defaultData = {
  categories: [
    {id: 1, name: "Habits", emoji: "👕", couleur: "category-habits"},
    {id: 2, name: "Cosmétiques", emoji: "💄", couleur: "category-cosmetiques"},
    {id: 3, name: "Chaussures", emoji: "👠", couleur: "category-chaussures"},
    {id: 4, name: "Accessoires", emoji: "💍", couleur: "category-accessoires"}
  ],
  produits: [], // start empty to prefer server data after first sync
  ventes: [],
  panier: [],
  stats: { ventesJour: 0, chiffreAffaires: 0, paiements: {especes: 0, wave: 0, orange: 0} }
};

let appData = null;
let chartVentesByDay = null, chartTopProduits = null, chartPaiements = null;

// ---------- localStorage helpers ----------
function loadAppDataLocal(){
  const raw = localStorage.getItem('boutique_appData');
  if(raw){
    try{ appData = JSON.parse(raw); }
    catch(e){ appData = JSON.parse(JSON.stringify(defaultData)); }
  } else appData = JSON.parse(JSON.stringify(defaultData));
  appData.produits.forEach(p=>{ if(typeof p.priceAchat === 'undefined') p.priceAchat = p.price_achat || 0; });
  // ensure outbox exists
  if(!localStorage.getItem('boutique_outbox')) localStorage.setItem('boutique_outbox', JSON.stringify([]));
}
function saveAppDataLocal(){ localStorage.setItem('boutique_appData', JSON.stringify(appData)); }

// ---------- Outbox / Background retry ----------
function enqueueOutbox(item){ // item example: {type:'sale', payload: {...}, tries:0, id: Date.now()}
  const q = JSON.parse(localStorage.getItem('boutique_outbox')||'[]'); q.push(item); localStorage.setItem('boutique_outbox', JSON.stringify(q)); }

async function processOutboxOne(){
  const q = JSON.parse(localStorage.getItem('boutique_outbox')||'[]');
  if(!q.length) return null;
  const item = q[0];
  try{
    let res=null;
    if(item.type==='sale') res = await postSaleServer(item.payload);
    else if(item.type==='product') res = await postProductServer(item.payload);
    else if(item.type==='category') res = await postCategoryServer(item.payload);

    if(res){ // success -> pop
      q.shift(); localStorage.setItem('boutique_outbox', JSON.stringify(q)); saveAppDataLocal();
      return {ok:true, item};
    } else {
      item.tries = (item.tries||0) + 1;
      if(item.tries > 10){ // drop after many tries
        console.warn('Dropping outbox item after many tries', item);
        q.shift(); localStorage.setItem('boutique_outbox', JSON.stringify(q));
        return {ok:false};
      }
      q[0] = item; localStorage.setItem('boutique_outbox', JSON.stringify(q));
      return {ok:false};
    }
  }catch(err){ console.warn('Outbox process error', err); return {ok:false}; }
}

async function processOutboxAll(){ let did=false; try{ while(true){ const r = await processOutboxOne(); if(!r) break; if(r.ok) did=true; else break; } }catch(e){ console.warn(e); } return did; }

// periodic retry
setInterval(()=>{ if(navigator.onLine) processOutboxAll(); }, 30*1000); // try every 30s if online
window.addEventListener('online', ()=>{ console.log('Back online -> retry outbox'); processOutboxAll(); });

// ---------- Sync with server (read only) ----------
async function syncFromServer() {
  const syncBanner = document.getElementById('syncBanner');
  if (syncBanner) syncBanner.style.display = 'block';

  if (!navigator.onLine) {
    console.warn('Mode hors ligne : données locales utilisées.');
    if (syncBanner) syncBanner.style.display = 'none';
    return;
  }

  try {
    // Récupération en parallèle avec authFetch
    const [resCat, resProd, resStats, resSales] = await Promise.all([
      authfetch(API_BASE + '/categories'),
      authfetch(API_BASE + '/products'),
      authfetch(API_BASE + '/stats/ventes-par-jour'),
      authfetch(API_BASE + '/sales'),
    ]);

    // --- Catégories ---
    if (resCat.ok) {
      const cats = await resCat.json();
      const defaultCategoryStyles = [
        { emoji: '👕', couleur: 'category-habits' },
        { emoji: '💄', couleur: 'category-cosmetiques' },
        { emoji: '👠', couleur: 'category-chaussures' },
        { emoji: '💍', couleur: 'category-accessoires' },
        { emoji: '🧴', couleur: 'bg-blue-400' },
        { emoji: '✨', couleur: 'bg-yellow-400' }
      ];
      appData.categories = cats.map((c, index) => {
        const style = defaultCategoryStyles[index % defaultCategoryStyles.length];
        return {
          id: parseInt(c.id),
          name: c.name,
          emoji: c.emoji || style.emoji,
          couleur: c.couleur || style.couleur
        };
      });
    }

    // --- Produits ---
    if (resProd.ok) {
      const prods = await resProd.json();
      appData.produits = prods.map(p => ({
        id: parseInt(p.id),
        name: p.name,
        category_id: parseInt(p.category_id),
        scent: p.scent,
        price: p.price,
        stock: p.stock,
        vendu: 0,
        priceAchat: p.price_achat || 0,
        description: p.description || ''
      }));
    }

    // --- Ventes ---
    let ventesAll = [];
    if (resSales.ok) {
      ventesAll = await resSales.json();
      appData.ventes = ventesAll;
    }

    // --- Calcul répartition paiements ---
    const paiementsMap = {};
    ventesAll.forEach(v => {
      const method = v.payment_method || 'inconnu';
      const montant = parseFloat(v.total || (v.price || 0) * (v.quantity || 0)) || 0;
      paiementsMap[method] = (paiementsMap[method] || 0) + montant;
    });
    appData.stats.paiements = paiementsMap;

    // --- Stats ventes du jour ---
    if (resStats.ok) {
      const statsArray = await resStats.json();
      const today = new Date().toISOString().split('T')[0];
      const todayStat = statsArray.find(s => s.date.startsWith(today));

      appData.stats.ventesJour = todayStat ? parseInt(todayStat.total_montant, 10) : 0;
      appData.stats.chiffreAffaires = appData.stats.ventesJour;
      appData.stats.historique = statsArray;
    }

    // --- Recalcul vendu + articles vendus ---
    const today = new Date().toISOString().split('T')[0];
    appData.produits.forEach(prod => { prod.vendu = 0; });
    let totalQteToday = 0;

    ventesAll.forEach(v => {
      const prodId = parseInt(v.product_id);
      const qte = v.quantity || 0;

      const prod = appData.produits.find(p => p.id === prodId);
      if (prod) prod.vendu += qte;

      const venteDate = new Date(v.date || v.created_at || v.timestamp);
      if (!isNaN(venteDate) && venteDate.toISOString().split('T')[0] === today) {
        totalQteToday += qte;
      }
    });

    appData.stats.articlesVendus = totalQteToday;

    // --- Sauvegarde ---
    saveAppDataLocal();
    console.log('✅ Sync from server done');

  } catch (err) {
    console.warn('❌ Erreur lors de la synchronisation depuis le serveur', err);
    console.warn('⚠️ Impossible de contacter le serveur API. Vérifiez la connexion ou la configuration CORS.');
  }

  if (syncBanner) syncBanner.style.display = 'none';
}


async function postCategoryServer(category) {
  try {
    const res = await authfetch(API_BASE + '/categories', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(category) // category = { name: "..." }
    });

    if (!res.ok) {
      const errorMsg = await res.text();
      console.warn('Add category failed', errorMsg);
      return null;
    }

    return await res.json();
  } catch (e) {
    console.warn('Network error adding category', e);
    return null;
  }
}

async function postProductServer(product) {
  try {
    const res = await authfetch(API_BASE + '/products', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(product)
    });
    if (!res.ok) {
      const errorMsg = await res.text();
      console.warn('Add product failed', errorMsg);
      return null;
    }
    return await res.json();
  } catch (e) {
    console.warn('Network error adding product', e);
    return null;
  }
}


async function postSaleServer(sale) {
  try {
    const res = await authfetch(API_BASE + '/sales', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(sale) // { product_id, quantity, payment_method }
    });

    if (!res.ok) {
      const errorMsg = await res.text();
      console.warn('Sale post failed', errorMsg);
      return null;
    }

    return await res.json();
  } catch (e) {
    console.warn('Network error posting sale', e);
    return null;
  }
}


// ---------- Navigation & UI helpers (structure kept) ----------
let currentSection = 'menu';
function showSection(section){
  const sections = ['menu','vente','stock','categories','rapports','inventaire'];
  sections.forEach(function(s){ const el = document.getElementById(s+'Section'); if(el) el.classList.add('hidden'); });
  const target = document.getElementById(section+'Section'); if(target) target.classList.remove('hidden');
  const backBtn = document.getElementById('backBtn'); if(backBtn) backBtn.style.display = (section==='menu') ? 'none' : 'block';
  currentSection = section;
  if(section==='vente'){ afficherCategoriesVente(); afficherPanier(); }
  else if(section==='stock'){ afficherProduits(); afficherFiltresCategories(); }
  else if(section==='categories'){ afficherCategories(); }
  else if(section==='rapports'){ afficherRapports(); }
  else if(section==='inventaire'){ afficherInventaire(); }
  else if(section==='menu'){ updateStats(); verifierStockFaible(); }
}

function showModal(modalName){
  const overlay = document.getElementById('modalOverlay'); if(overlay) overlay.classList.remove('hidden');
  const modalId = 'modal' + modalName.charAt(0).toUpperCase() + modalName.slice(1);
  const modalEl = document.getElementById(modalId);
  if(modalEl) modalEl.classList.remove('hidden');
  if(modalName==='ajoutProduit') remplirSelectCategories();
}
function hideModal(){
  const overlay = document.getElementById('modalOverlay'); if(overlay) overlay.classList.add('hidden');
  document.querySelectorAll('[id^="modal"]').forEach(function(m){ m.classList.add('hidden'); });
  ['nomProduit','categorieProduit','prixProduit','prixAchatProduit','stockProduit','descriptionProduit','nomCategorie','emojiCategorie'].forEach(function(id){ const el=document.getElementById(id); if(el) el.value=''; });
  document.querySelectorAll('.emoji-btn').forEach(function(btn){ btn.classList.remove('bg-blue-200','border-blue-400'); });
}

// ---------- Stats & alerts ----------
function updateStats(){
  if(!appData) return;
  const ventesTodayEl = document.getElementById('ventesToday'); if(ventesTodayEl) ventesTodayEl.textContent = appData.stats.ventesJour || 0;
  const chiffreEl = document.getElementById('chiffreAffaires'); if(chiffreEl) chiffreEl.textContent = (appData.stats.chiffreAffaires||0).toLocaleString() + ' F';
const articlesEl = document.getElementById('articlesVendus');
if (articlesEl) articlesEl.textContent = appData.stats.articlesVendus || 0;
  const stockTotalEl = document.getElementById('stockTotal'); if(stockTotalEl) stockTotalEl.textContent = appData.produits.reduce(function(t,p){ return t + (p.stock||0); }, 0);
}
function verifierStockFaible(){
  if(!appData) return;
  const low = appData.produits.filter(function(p){ return p.stock>0 && p.stock<=5; });
  const div = document.getElementById('produitsStockFaible'); const alertDiv = document.getElementById('alertesStock');
  if(low.length){ if(alertDiv) alertDiv.style.display = 'block'; if(div) div.innerHTML = ''; low.forEach(function(produit){ const cat = appData.categories.find(function(c){ return c.id === produit.category_id; }); const el = document.createElement('div'); el.className = 'bg-white rounded-xl p-3 flex justify-between items-center'; el.innerHTML = '<span class="font-bold">' + (cat?cat.emoji:'📦') + ' ' + produit.name + '</span><span class="text-red-600 font-bold">' + produit.stock + ' restants</span>'; if(div) div.appendChild(el); }); }
  else if(alertDiv) alertDiv.style.display = 'none';
}

// ---------- Vente / Panier ----------
function afficherCategoriesVente(){ const ctn=document.getElementById('categoriesVente'); if(!ctn) return; ctn.innerHTML=''; if (appData.categories.length === 0) {
  ctn.innerHTML = '<div class="text-gray-500 text-center py-4">Aucune catégorie disponible</div>';
  return;
}
 appData.categories.forEach(function(cat){ const produitsCategorie = appData.produits.filter(function(p){ return p.category_id===cat.id && p.stock>0; }); if(!produitsCategorie.length) return; const d=document.createElement('div'); d.className = 'big-button ' + (cat.couleur || '') + ' text-white p-4 rounded-2xl text-center cursor-pointer shadow-lg'; d.addEventListener('click', function(){ afficherProduitsCategorie(cat.id); }); d.innerHTML = '<div class="text-4xl mb-2">' + (cat.emoji||'') + '</div><div class="font-bold">' + cat.name + '</div><div class="text-sm opacity-90">' + produitsCategorie.length + ' produits</div>'; ctn.appendChild(d); }); }

function afficherProduitsCategorie(categorieId){ const produits = appData.produits.filter(function(p){ return p.category_id===categorieId && p.stock>0; }); const container=document.getElementById('categoriesVente'); if(!container) return; container.innerHTML = '';const retourBtn = document.createElement('button');retourBtn.textContent = '← Retour';retourBtn.className = 'col-span-2 mb-4 text-blue-600 font-bold';retourBtn.addEventListener('click', afficherCategoriesVente);container.appendChild(retourBtn);
  produits.forEach(function(produit){ const div=document.createElement('div'); div.className='bg-white border-2 border-gray-200 p-4 rounded-2xl text-center cursor-pointer hover:border-blue-400 transition-all'; div.addEventListener('click', function(){ ajouterAuPanier(produit); }); div.innerHTML = '<div class="font-bold text-lg mb-1">' + produit.name + '</div><div class="text-2xl font-bold text-green-600 mb-1">' + (produit.price||0).toLocaleString() + ' F</div><div class="text-sm text-gray-600">Stock: ' + (produit.stock||0) + '</div>'; container.appendChild(div); }); }

function ajouterAuPanier(produit){ if(!appData) return; const exist = appData.panier.find(function(i){ return i.id===produit.id; }); if(exist){ if(exist.quantite < produit.stock) exist.quantite++; else { alert('❌ Stock insuffisant!'); return; } } else appData.panier.push(Object.assign({}, produit, {quantite:1})); afficherPanier(); saveAppDataLocal(); }

function afficherPanier(){ const c=document.getElementById('panierItems'); const total=document.getElementById('totalPanier'); if(!c) return; if(!appData || !appData.panier || !appData.panier.length){ c.innerHTML = '<div class="text-gray-500 text-center py-8"><div class="text-4xl mb-2">🛒</div><div>Panier vide</div></div>'; if(total) total.textContent = '0 F'; return; }
  c.innerHTML=''; var totalPrix = 0; appData.panier.forEach(function(item){ const div=document.createElement('div'); div.className='flex justify-between items-center bg-gray-50 rounded-2xl p-3'; div.innerHTML = '<div><div class="font-bold">' + item.name + '</div><div class="text-sm text-gray-600">' + (item.price||0).toLocaleString() + ' F × ' + item.quantite + '</div></div><div class="flex items-center gap-2"><button class="bg-red-500 text-white w-8 h-8 rounded-full text-sm font-bold">-</button><span class="font-bold text-lg w-8 text-center">' + item.quantite + '</span><button class="bg-green-500 text-white w-8 h-8 rounded-full text-sm font-bold">+</button></div>'; // wire buttons
    c.appendChild(div);
    // attach handlers to +/- buttons
    const btns = div.querySelectorAll('button'); if(btns && btns.length>=2){ btns[0].addEventListener('click', function(){ modifierQuantitePanier(item.id, -1); }); btns[1].addEventListener('click', function(){ modifierQuantitePanier(item.id, 1); }); }
    totalPrix += (item.price||0) * item.quantite;
  }); if(total) total.textContent = totalPrix.toLocaleString() + ' F'; }

function modifierQuantitePanier(id, delta){ if(!appData) return; const item = appData.panier.find(function(i){ return i.id===id; }); const produit = appData.produits.find(function(p){ return p.id===id; }); if(item){ item.quantite += delta; if(item.quantite <= 0) appData.panier = appData.panier.filter(function(i){ return i.id !== id; }); else if(produit && item.quantite > produit.stock){ item.quantite = produit.stock; alert('❌ Stock insuffisant!'); } afficherPanier(); saveAppDataLocal(); } }

async function finaliserVente(paymentMethod) {
  if (!appData.panier.length) {
    alert('❌ Panier vide.');
    return;
  }

  // Envoi des ventes une par une au backend
  for (const item of appData.panier) {
    const vente = {
      product_id: item.id,
      quantity: item.quantite,
      payment_method: paymentMethod
    };
    const created = await postSaleServer(vente);
    if (!created) {
      alert('❌ Erreur lors de l\'enregistrement de la vente.');
      return;
    }
  }

  alert('✅ Vente enregistrée.');

  // Vider le panier local
  appData.panier = [];
  saveAppDataLocal();

  // Recharger toutes les données depuis le serveur (stats, ventes, produits, etc.)
  await syncFromServer();

  // Rafraîchir toute l'UI avec les données à jour
  updateStats();
  afficherCategoriesVente();
  afficherProduits();
  afficherCategories();
  afficherRapports();
  afficherInventaire();
  verifierStockFaible();

  hideModal();
}


// ---------- Produits / catégories gestion (avec POST) ----------
function remplirSelectCategories(){ const select = document.getElementById('categorieProduit'); if(!select) return; select.innerHTML = '<option value="">Choisir catégorie</option>'; appData.categories.forEach(function(categ){ var opt = document.createElement('option'); opt.value = categ.id; opt.textContent = (categ.emoji ? categ.emoji + ' ' : '') + categ.name; select.appendChild(opt); }); }

async function ajouterProduit(){
  const name = document.getElementById('nomProduit').value;
  const category_id = parseInt(document.getElementById('categorieProduit').value);
  const scentEl = document.getElementById('parfumProduit');
  const scent = scentEl ? scentEl.value : '';
  const priceAchat = parseFloat(document.getElementById('prixAchatProduit').value); // ✅ prix achat
  const price = parseFloat(document.getElementById('prixProduit').value);
  const stock = parseInt(document.getElementById('stockProduit').value);

  // Validation
  if (!name || !category_id || isNaN(price) || isNaN(stock) || isNaN(priceAchat)) {
    alert('❌ Remplissez tous les champs correctement.');
    return;
  }

  // ✅ envoyer avec le nom correct pour la BDD
  const produit = {
    name: name,
    category_id: category_id,
    scent: scent,
    price: price,
    price_achat: priceAchat,
    stock: stock
  };

  const created = await postProductServer(produit);
  if (created) {
    alert('✅ Produit ajouté (serveur).');
    await syncFromServer();
    updateStats();
    verifierStockFaible();
    afficherCategoriesVente();
    afficherProduits();
    afficherCategories();
    afficherRapports();
    afficherInventaire();
    hideModal();
  }
  else {
    alert('❌ Erreur lors de l\'ajout du produit.');
  }
}



async function ajouterCategorie(){
  if (!appData) return;

  const name = (document.getElementById('nomCategorie') || {}).value;
  const emoji = (document.getElementById('emojiCategorie') || {}).value || '🏷️';

  if (name) {
    const newCatLocal = { id: Date.now(), name: name, emoji: emoji, couleur: 'category-habits' };
    appData.categories.push(newCatLocal);

    if (currentSection === 'categories') afficherCategories();
    hideModal();
    saveAppDataLocal();

    const created = await postCategoryServer({ name: name }); // ✅ envoie "name"
    if (created) {
      const idx = appData.categories.findIndex(c => c.id === newCatLocal.id);
      if (idx >= 0) appData.categories[idx] = created;
      saveAppDataLocal();
      syncFromServer();
      alert('✅ Catégorie ajoutée (serveur).');
      await syncFromServer();
      afficherCategories();
      afficherCategoriesVente();
      afficherProduits();

    } else {
      enqueueOutbox({ type: 'category', payload: { name: name }, tries: 0, id: Date.now() });
      alert('✅ Catégorie ajoutée localement et mise en file d\'envoi.');
    }
  } else {
    alert('❌ Saisir un name');
  }
}


function afficherFiltresCategories(){ const container = document.getElementById('filtreCategories'); if(!container) return; container.innerHTML = ''; var btnAll = document.createElement('button'); btnAll.className = 'filtre-btn bg-blue-500 text-white px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap'; btnAll.textContent = 'Tous'; btnAll.addEventListener('click', function(){ filtrerProduits('tous'); }); container.appendChild(btnAll);
  appData.categories.forEach(function(c){ var button = document.createElement('button'); button.className = 'filtre-btn bg-gray-200 px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap'; button.textContent = (c.emoji?c.emoji+' ':'') + c.name; button.addEventListener('click', function(){ filtrerProduits(c.id); }); container.appendChild(button); }); }

function filtrerProduits(categorieId){ document.querySelectorAll('.filtre-btn').forEach(function(btn){ btn.classList.remove('bg-blue-500','text-white'); btn.classList.add('bg-gray-200'); }); if(window.event && window.event.target){ var t = window.event.target; t.classList.add('bg-blue-500','text-white'); t.classList.remove('bg-gray-200'); } afficherProduits(categorieId); }

function afficherProduits(categorieFilter) { 
  if (typeof categorieFilter === 'undefined') categorieFilter = 'tous';
  
  const container = document.getElementById('listeProduits');
  if (!container) return;
  
  container.innerHTML = '';
  
  let produits = appData.produits.slice();
  
  if (produits.length === 0) {
    container.innerHTML = '<div class="text-gray-500 text-center py-4">Aucun produit trouvé</div>';
    return;
  }
  
  if (categorieFilter !== 'tous') {
    produits = produits.filter(p => p.category_id === categorieFilter);
  }
  
  produits.forEach(function(produit) {
    const categorie = appData.categories.find(c => c.id === produit.category_id);
    
    const stockColor = (produit.stock < 5) ? 'text-red-600' : 
                       (produit.stock < 10) ? 'text-orange-600' : 
                       'text-green-600';
    
    let stockBadge = '';
    if (produit.stock <= 5) {
      stockBadge = `<span class="ml-2 inline-block px-2 py-0.5 text-xs font-bold text-white bg-red-500 rounded-full">⚠️</span>`;
    } else if (produit.stock < 10) {
      stockBadge = `<span class="ml-2 inline-block px-2 py-0.5 text-xs font-bold text-white bg-orange-500 rounded-full">⚠️</span>`;
    }
    
    let bgAlertClass = '';
    if (produit.stock <= 5) bgAlertClass = 'bg-red-50';
    else if (produit.stock < 10) bgAlertClass = 'bg-orange-50';
    
    const div = document.createElement('div');
    div.className = 'rounded-2xl p-4 shadow-lg ' + bgAlertClass;
    
    const descriptionHtml = produit.description
      ? `<div class="text-xs text-gray-500 mt-1">${produit.description}</div>`
      : '';
    
    div.innerHTML =
      `<div class="flex justify-between items-start mb-3">
         <div>
           <div class="text-lg font-bold">${produit.name}</div>
           <div class="text-sm text-gray-600">
             ${categorie ? (categorie.emoji + ' ' + categorie.name) : 'Sans catégorie'}
           </div>
           ${descriptionHtml}
         </div>
         <div class="text-right">
           <div class="text-xl font-bold text-green-600">${(produit.price || 0).toLocaleString()} F</div>
           <div class="text-sm ${stockColor} font-bold">Stock: ${produit.stock || 0}${stockBadge}</div>
           <div class="text-xs text-gray-500">Achat: ${(produit.priceAchat || produit.price_achat || 0).toLocaleString()} F</div>
         </div>
       </div>
       <div class="flex gap-2">
         <button class="btn-edit bg-yellow-500 text-white px-4 py-2 rounded-lg text-sm font-bold">✏️ Éditer</button>
         <button class="btn-mod-stock-minus bg-red-500 text-white px-4 py-2 rounded-lg text-sm font-bold">- Stock</button>
         <button class="btn-mod-stock-plus bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-bold">+ Stock</button>
         <button class="btn-suppr bg-gray-500 text-white px-4 py-2 rounded-lg text-sm">🗑️</button>
       </div>`;
    
    container.appendChild(div);

    const btnEdit = div.querySelector('.btn-edit');
    if (btnEdit) btnEdit.addEventListener('click', () => ouvrirModalEdit(produit));

    
    // Wire buttons
    const btnMinus = div.querySelector('.btn-mod-stock-minus');
    if (btnMinus) btnMinus.addEventListener('click', () => modifierStock(produit.id, -1));
    
    const btnPlus = div.querySelector('.btn-mod-stock-plus');
    if (btnPlus) btnPlus.addEventListener('click', () => modifierStock(produit.id, 1));
    
    const btnSuppr = div.querySelector('.btn-suppr');
    if (btnSuppr) btnSuppr.addEventListener('click', () => supprimerProduit(produit.id));
  });
}

function modifierStock(id, delta){
  var produit = appData.produits.find(function(p){ return p.id === id; });
  if(produit && produit.stock + delta >= 0){
    produit.stock += delta;
    afficherProduits();
    updateStats();
    saveAppDataLocal();

    // ✅ on envoie bien "price_achat"
    authfetch(API_BASE + '/products/' + id, {
      method:'PATCH', // PATCH plutôt que PUT pour ne mettre à jour que les champs modifiés
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        name: produit.name,
        price: produit.price,
        price_achat: produit.priceAchat || produit.price_achat || 0,
        stock: produit.stock,
        description: produit.description
      })
    }).then(function(r){
      if(!r.ok) console.warn('update failed');
    }).catch(function(){});
  }
}


function supprimerProduit(id){ if(confirm('❓ Supprimer ce produit ?')){ appData.produits = appData.produits.filter(function(p){ return p.id !== id; }); afficherProduits(); updateStats(); saveAppDataLocal(); authfetch(API_BASE + '/products/' + id, { method:'DELETE' }).catch(function(){}); alert('✅ Supprimé'); } }

// ---------- Catégories UI ----------
function selectEmoji(emoji){ var el = document.getElementById('emojiCategorie'); if(el) el.value = emoji; document.querySelectorAll('.emoji-btn').forEach(function(btn){ btn.classList.remove('bg-blue-200','border-blue-400'); }); if(window.event && window.event.target) window.event.target.classList.add('bg-blue-200','border-blue-400'); }

function afficherCategories(){
  var ctn = document.getElementById('listeCategories');
  if(!ctn) return;
  ctn.innerHTML = '';
  
  if (appData.categories.length === 0) {
    ctn.innerHTML = '<div class="text-gray-500 text-center py-4">Aucune catégorie trouvée</div>';
    return;
  }

  appData.categories.forEach(function(cat){
    var produitsCount = appData.produits.filter(function(p){ return p.category_id === cat.id; }).length;
    
    var div = document.createElement('div');
    div.className = (cat.couleur || '') + ' text-white rounded-2xl p-6 shadow-lg';
    div.innerHTML = `
      <div class="flex justify-between items-center">
        <div>
          <div class="text-4xl mb-2">${cat.emoji || ''}</div>
          <div class="text-xl font-bold">${cat.name}</div>
          <div class="text-sm opacity-90">${produitsCount} produits</div>
        </div>
        <button class="bg-white bg-opacity-20 text-white px-3 py-2 rounded-lg text-sm">🗑️</button>
      </div>`;
    
    // Rendre le bouton actif
    const btn = div.querySelector('button');
    if (btn) {
      btn.addEventListener('click', () => supprimerCategorie(cat.id));
    }
    
    ctn.appendChild(div);
  });
}

async function supprimerCategorie(id) {
  if (!confirm('❓ Supprimer cette catégorie ?')) return;

  try {
    const res = await authfetch(API_BASE + '/categories/' + id, { method: 'DELETE' });

    const data = await res.json();

    if (!res.ok) {
      // 🔴 Erreur renvoyée par le backend
      alert('❌ ' + (data.error || 'Erreur lors de la suppression de la catégorie'));
      return;
    }

    // ✅ Suppression réussie
    alert('✅ ' + (data.message || 'Catégorie supprimée avec succès'));

    // Retirer de la liste locale
    appData.categories = appData.categories.filter(c => c.id !== id);
    afficherCategories();
    saveAppDataLocal();

  } catch (err) {
    console.error('Erreur réseau lors de la suppression de catégorie', err);
    alert('❌ Impossible de contacter le serveur.');
  }
}

// ---------- Rapports & charts ----------
function afficherRapports() {
  // --- Résumé ---
  var recettesJour = document.getElementById('recettesJour');
  if (recettesJour) recettesJour.textContent = (appData.stats.chiffreAffaires || 0).toLocaleString() + ' F';

  var recettesSemaine = document.getElementById('recettesSemaine');
  if (recettesSemaine) recettesSemaine.textContent = (appData.stats.chiffreAffaires || 0).toLocaleString() + ' F';

  // --- Paiements ---
  var containerPaiements = document.getElementById('rapportsPaiements');
  if (containerPaiements) containerPaiements.innerHTML = '';

  var methodesNoms = {
    especes: { name: 'Espèces', emoji: '💵', couleur: 'green' },
    wave: { name: 'Wave', emoji: '📱', couleur: 'blue' },
    orange: { name: 'Orange Money', emoji: '📞', couleur: 'orange' }
  };

  var paiements = appData.stats.paiements || {};
  var totalPaiements = Object.values(paiements).reduce((sum, val) => sum + val, 0);

  Object.keys(paiements).forEach(function(m) {
    var montant = paiements[m] || 0;
    var info = methodesNoms[m] || { name: m, emoji: '', couleur: 'gray' };
    var pct = totalPaiements > 0 ? ((montant / totalPaiements) * 100).toFixed(1) : 0;

    var div = document.createElement('div');
    div.className = `bg-${info.couleur}-50 rounded-2xl p-3 flex justify-between items-center`;
    div.innerHTML = `
      <div class="flex items-center gap-3">
        <span class="text-2xl">${info.emoji || ''}</span>
        <span class="font-bold">${info.name}</span>
      </div>
      <div class="text-right">
        <div class="font-bold">${montant.toLocaleString()} F</div>
        <div class="text-xs text-gray-600">${pct}% du total</div>
      </div>
    `;
    containerPaiements.appendChild(div);
  });

  // --- Produits populaires ---
  var cPop = document.getElementById('produitsPopulaires');
  if (cPop) cPop.innerHTML = '';
  var populaires = appData.produits.filter(function(p) { return p.vendu > 0; })
    .sort(function(a, b) { return b.vendu - a.vendu; })
    .slice(0, 5);
  if (!populaires.length && cPop)
    cPop.innerHTML = '<div class="text-gray-500 text-center py-4">Aucune vente</div>';
  else
    populaires.forEach(function(p) {
      var d = document.createElement('div');
      d.className = 'flex justify-between items-center bg-gray-50 rounded-lg p-3';
      d.innerHTML = '<div class="font-bold">' + p.name + '</div><div class="text-blue-600 font-bold">' + p.vendu + ' vendus</div>';
      if (cPop) cPop.appendChild(d);
    });

  // --- Mettre à jour tous les graphiques ---
  updateCharts();
}

function updateCharts() {
  var ventes = appData.ventes || [];

  // --- Graphique ventes par jour ---
  var byDay = {};
  ventes.forEach(function(v) {
    if (!v.date) return;
    let dateObj = new Date(v.date || v.created_at || v.timestamp);
    if (isNaN(dateObj)) return;
    var d = dateObj.toISOString().slice(0, 10);
    byDay[d] = (byDay[d] || 0) + (v.total || (v.price || 0) * (v.quantity || 0));
  });
  var labels = Object.keys(byDay).sort();
  var data = labels.map(function(l) { return byDay[l]; });
  if (chartVentesByDay) chartVentesByDay.destroy();
  var ctx1 = document.getElementById('chartVentesByDay');
  if (ctx1) {
    chartVentesByDay = new Chart(ctx1.getContext('2d'), {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Total ventes par jour',
          data: data,
          borderColor: '#4f46e5',
          backgroundColor: 'rgba(79,70,229,0.15)',
          fill: true
        }]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });
  }

  // --- Produits populaires ---
  var productsSorted = (appData.produits || []).slice().sort(function(a, b) {
    return (b.vendu || 0) - (a.vendu || 0);
  }).slice(0, 8);
  var labels2 = productsSorted.map(function(p) { return p.name; });
  var data2 = productsSorted.map(function(p) { return p.vendu || 0; });
  if (chartTopProduits) chartTopProduits.destroy();
  var ctx2 = document.getElementById('chartTopProduits');
  if (ctx2) {
    chartTopProduits = new Chart(ctx2.getContext('2d'), {
      type: 'bar',
      data: {
        labels: labels2,
        datasets: [{
          label: 'Quantités vendues',
          data: data2,
          backgroundColor: 'rgba(16,185,129,0.8)'
        }]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });
  }

  // --- Graphique paiements avec pourcentages ---
  var pays = appData.stats.paiements || {};
  var totalPaiements = Object.values(pays).reduce((sum, val) => sum + val, 0);
  var labels3 = Object.keys(pays).map(function(k) {
    var pct = totalPaiements > 0 ? ((pays[k] / totalPaiements) * 100).toFixed(1) : 0;
    return `${k.charAt(0).toUpperCase() + k.slice(1)} (${pct}%)`;
  });
  var data3 = Object.keys(pays).map(function(k) { return pays[k] || 0; });
  if (chartPaiements) chartPaiements.destroy();
  var ctx3 = document.getElementById('chartPaiements');
  if (ctx3) {
    chartPaiements = new Chart(ctx3.getContext('2d'), {
      type: 'pie',
      data: {
        labels: labels3,
        datasets: [{
          data: data3,
          backgroundColor: ['#10b981', '#3b82f6', '#f97316', '#6b7280'] // Vert, bleu, orange, gris
        }]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });
  }

  // --- Graphique stocks faibles ---
  var produitsFaibles = (appData.produits || []).filter(p => p.stock <= 5);
  var labelsStock = produitsFaibles.map(p => p.name);
  var dataStock = produitsFaibles.map(p => p.stock);
  if (window.chartStocksFaibles && typeof window.chartStocksFaibles.destroy === 'function') {
    window.chartStocksFaibles.destroy();
  }
  var ctxStock = document.getElementById('chartStocksFaibles');
  if (ctxStock) {
    window.chartStocksFaibles = new Chart(ctxStock.getContext('2d'), {
      type: 'bar',
      data: {
        labels: labelsStock,
        datasets: [{
          label: 'Stock restant',
          data: dataStock,
          backgroundColor: 'rgba(239,68,68,0.8)'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        scales: { x: { beginAtZero: true } }
      }
    });
  }
}


// ---------- Inventaire ----------
function afficherInventaire(){ var tbody = document.getElementById('inventaireListe'); if(!tbody) return; tbody.innerHTML=''; if (appData.produits.length === 0) {
  tbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 py-4">Aucun produit dans l’inventaire</td></tr>';
  return;
}
 appData.produits.forEach(function(p){ var profitRealise = (p.vendu || 0) * ((p.price || 0) - (p.priceAchat || p.price_achat || 0)); var tr = document.createElement('tr'); tr.innerHTML = '<td class="p-2 border">' + p.name + '</td><td class="p-2 border">' + ((p.priceAchat||p.price_achat||0).toLocaleString()) + ' F</td><td class="p-2 border">' + ((p.price||0).toLocaleString()) + ' F</td><td class="p-2 border">' + (p.stock||0) + '</td><td class="p-2 border">' + (p.vendu||0) + '</td><td class="p-2 border">' + profitRealise.toLocaleString() + ' F</td>'; tbody.appendChild(tr); }); }

// ---------- Search handlers for inventory and categories ----------
function setupSearchInputs(){ var inv = document.getElementById('searchInventaire'); if(inv){ inv.addEventListener('input', function(){ var term = this.value.toLowerCase(); document.querySelectorAll('#inventaireListe tr').forEach(function(row){ var prodName = (row.cells[0] && row.cells[0].textContent || '').toLowerCase(); row.style.display = prodName.indexOf(term) !== -1 ? '' : 'none'; }); }); }
  var cat = document.getElementById('searchCategorie'); if(cat){ cat.addEventListener('input', function(){ var term = this.value.toLowerCase(); document.querySelectorAll('#listeCategories > div').forEach(function(div){ var catName = (div.textContent || '').toLowerCase(); div.style.display = catName.indexOf(term) !== -1 ? '' : 'none'; }); }); }
}

// ---------- Init ----------
document.addEventListener('DOMContentLoaded', async function(){
  loadAppDataLocal();
  updateStats();
  verifierStockFaible();
  afficherCategoriesVente();
  afficherProduits();
  afficherCategories();
  afficherRapports();
  afficherInventaire();
  setupSearchInputs();

  // Première synchro serveur
  await syncFromServer();
  updateStats();
  verifierStockFaible();
  afficherCategoriesVente();
  afficherProduits();
  afficherCategories();
  afficherRapports();
  afficherInventaire();

  // 🔄 Rafraîchissement auto toutes les 30 secondes
  setInterval(async () => {
    await syncFromServer();
    updateStats();
    verifierStockFaible();
    afficherCategoriesVente();
    afficherProduits();
    afficherCategories();
    afficherRapports();
    afficherInventaire();
  }, 30000);
});


// Register service worker if supported
if('serviceWorker' in navigator){ window.addEventListener('load', function(){ navigator.serviceWorker.register('./pwa/sw.js').then(function(reg){ console.log('SW registered', reg); }).catch(function(err){ console.warn('SW failed', err); }); }); }

function ouvrirModalEdit(produit) {
  // Remplir le formulaire
  document.getElementById('editNomProduit').value = produit.name;
  document.getElementById('editCategorieProduit').innerHTML = '<option value="">Choisir catégorie</option>';
  appData.categories.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = (c.emoji ? c.emoji + ' ' : '') + c.name;
    if (c.id === produit.category_id) opt.selected = true;
    document.getElementById('editCategorieProduit').appendChild(opt);
  });
  document.getElementById('editPrixAchatProduit').value = produit.priceAchat || produit.price_achat || 0;
  document.getElementById('editPrixProduit').value = produit.price;
  document.getElementById('editStockProduit').value = produit.stock;
  document.getElementById('editDescriptionProduit').value = produit.description || '';

  // Stocker l'ID du produit en cours d'édition
  document.getElementById('modalEditProduit').dataset.id = produit.id;

  // Afficher la modale
  showModal('editProduit');
}

async function mettreAJourProduit() {
  const id = document.getElementById('modalEditProduit').dataset.id;
  const produit = {
    name: document.getElementById('editNomProduit').value,
    category_id: parseInt(document.getElementById('editCategorieProduit').value),
    price_achat: parseFloat(document.getElementById('editPrixAchatProduit').value),
    price: parseFloat(document.getElementById('editPrixProduit').value),
    stock: parseInt(document.getElementById('editStockProduit').value),
    description: document.getElementById('editDescriptionProduit').value
  };

  if (!produit.name || isNaN(produit.price) || isNaN(produit.price_achat) || isNaN(produit.stock)) {
    alert('❌ Remplissez tous les champs correctement.');
    return;
  }

  try {
    const res = await authfetch(API_BASE + '/products/' + id, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(produit)
    });

    if (!res.ok) {
      alert('❌ Erreur lors de la mise à jour du produit.');
      return;
    }

    alert('✅ Produit mis à jour.');
    hideModal();
    await syncFromServer();
    afficherProduits();
    afficherInventaire();
    updateStats();
  } catch (err) {
    console.error(err);
    alert('❌ Impossible de contacter le serveur.');
  }
}

</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let chartVentesJourInstance = null;
function renderVentesChart() {
  if (!appData.stats.historique || appData.stats.historique.length === 0) return;

  if (chartVentesJourInstance) {
    chartVentesJourInstance.destroy();
  }

  const labels = appData.stats.historique.map(s => new Date(s.date).toLocaleDateString());
  const dataCA = appData.stats.historique.map(s => parseInt(s.total_montant, 10));
  const dataQte = appData.stats.historique.map(s => parseInt(s.total_quantite || 0, 10));

  const ctx = document.getElementById('chartVentesJour').getContext('2d');
  chartVentesJourInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Chiffre d\'affaires (F)',
          data: dataCA,
          borderColor: 'rgb(75, 192, 192)',
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          yAxisID: 'y'
        },
        {
          label: 'Articles vendus',
          data: dataQte,
          borderColor: 'rgb(255, 99, 132)',
          backgroundColor: 'rgba(255, 99, 132, 0.2)',
          yAxisID: 'y1'
        }
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      stacked: false,
      scales: {
        y: { type: 'linear', position: 'left' },
        y1: { type: 'linear', position: 'right', grid: { drawOnChartArea: false } }
      }
    }
  });
}

function authfetch(url, options = {}) {
  const token = localStorage.getItem('authToken');
  if (!token) {
    // Pas connecté → on renvoie vers login
    window.location.href = 'login.html';
    return Promise.reject(new Error('Token manquant'));
  }

  const headers = {
    ...(options.headers || {}),
    'Authorization': 'Bearer ' + token
  };

  return fetch(url, { ...options, headers }).then(res => {
    if (res.status === 401) {
      alert('❌ Session expirée. Veuillez vous reconnecter.');
      localStorage.removeItem('authToken');
      window.location.href = 'login.html';
      throw new Error('401 Unauthorized');
    }
    return res;
  });
}


</script>



</body>
</html>
